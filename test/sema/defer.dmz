// RUN: compiler %s -res-dump 2>&1 | filecheck %s
// RUN: diff <(compiler %s -run) <(echo -n -e '5\n4\n1\n3\n2\n1\nSecond-last\nThe last one\n')

fn foo(x: int) -> void {
    defer dprintf(1, &"1\n");
    if (x == 1) {
        defer dprintf(1, &"2\n");
        defer dprintf(1, &"3\n");
        return;
    }else{
        defer dprintf(1, &"4\n");
        defer dprintf(1, &"5\n");
    }
    return;
}
//CHECK: ResolvedFunctionDecl foo -> void
//CHECK-NEXT:  ResolvedParamDecl:int x
//CHECK-NEXT:  ResolvedBlock
//CHECK-NEXT:    ResolvedIfStmt
//CHECK-NEXT:      ResolvedBinaryOperator:bool '=='
//CHECK-NEXT:        ResolvedDeclRefExpr:int x
//CHECK-NEXT:        ResolvedIntLiteral:int '1'
//CHECK-NEXT:      ResolvedBlock
//CHECK-NEXT:        ResolvedDeferStmt
//CHECK-NEXT:          ResolvedBlock
//CHECK-NEXT:            ResolvedCallExpr:int dprintf
//CHECK-NEXT:              ResolvedIntLiteral:int '1'
//CHECK-NEXT:              | value:int 1
//CHECK-NEXT:              ResolvedUnaryOperator:&char[3] '&'
//CHECK-NEXT:                ResolvedStringLiteral:char[3] '3\n'
//CHECK-NEXT:        ResolvedDeferStmt
//CHECK-NEXT:          ResolvedBlock
//CHECK-NEXT:            ResolvedCallExpr:int dprintf
//CHECK-NEXT:              ResolvedIntLiteral:int '1'
//CHECK-NEXT:              | value:int 1
//CHECK-NEXT:              ResolvedUnaryOperator:&char[3] '&'
//CHECK-NEXT:                ResolvedStringLiteral:char[3] '2\n'
//CHECK-NEXT:        ResolvedDeferStmt
//CHECK-NEXT:          ResolvedBlock
//CHECK-NEXT:            ResolvedCallExpr:int dprintf
//CHECK-NEXT:              ResolvedIntLiteral:int '1'
//CHECK-NEXT:              | value:int 1
//CHECK-NEXT:              ResolvedUnaryOperator:&char[3] '&'
//CHECK-NEXT:                ResolvedStringLiteral:char[3] '1\n'
//CHECK-NEXT:        ResolvedReturnStmt
//CHECK-NEXT:      ResolvedBlock
//CHECK-NEXT:        ResolvedDeferStmt
//CHECK-NEXT:          ResolvedBlock
//CHECK-NEXT:            ResolvedCallExpr:int dprintf
//CHECK-NEXT:              ResolvedIntLiteral:int '1'
//CHECK-NEXT:              | value:int 1
//CHECK-NEXT:              ResolvedUnaryOperator:&char[3] '&'
//CHECK-NEXT:                ResolvedStringLiteral:char[3] '5\n'
//CHECK-NEXT:        ResolvedDeferStmt
//CHECK-NEXT:          ResolvedBlock
//CHECK-NEXT:            ResolvedCallExpr:int dprintf
//CHECK-NEXT:              ResolvedIntLiteral:int '1'
//CHECK-NEXT:              | value:int 1
//CHECK-NEXT:              ResolvedUnaryOperator:&char[3] '&'
//CHECK-NEXT:                ResolvedStringLiteral:char[3] '4\n'
//CHECK-NEXT:    ResolvedDeferStmt
//CHECK-NEXT:      ResolvedBlock
//CHECK-NEXT:        ResolvedCallExpr:int dprintf
//CHECK-NEXT:          ResolvedIntLiteral:int '1'
//CHECK-NEXT:          | value:int 1
//CHECK-NEXT:          ResolvedUnaryOperator:&char[3] '&'
//CHECK-NEXT:            ResolvedStringLiteral:char[3] '1\n'
//CHECK-NEXT:    ResolvedReturnStmt

extern fn dprintf(fd:int, fmt:&char[], ...) -> int;

fn main() -> void {
    defer dprintf(1, &"The last one\n");
    foo(0);
    defer dprintf(1, &"Second-last\n");
    foo(1);
}
// CHECK: ResolvedFunctionDecl main -> void
// CHECK-NEXT:   ResolvedBlock
// CHECK-NEXT:     ResolvedCallExpr:void foo
// CHECK-NEXT:       ResolvedIntLiteral:int '0'
// CHECK-NEXT:       | value:int 0
// CHECK-NEXT:     ResolvedCallExpr:void foo
// CHECK-NEXT:       ResolvedIntLiteral:int '1'
// CHECK-NEXT:       | value:int 1
// CHECK-NEXT:     ResolvedDeferStmt
// CHECK-NEXT:       ResolvedBlock
// CHECK-NEXT:         ResolvedCallExpr:int dprintf
// CHECK-NEXT:           ResolvedIntLiteral:int '1'
// CHECK-NEXT:           | value:int 1
// CHECK-NEXT:           ResolvedUnaryOperator:&char[13] '&'
// CHECK-NEXT:             ResolvedStringLiteral:char[13] 'Second-last\n'
// CHECK-NEXT:     ResolvedDeferStmt
// CHECK-NEXT:       ResolvedBlock
// CHECK-NEXT:         ResolvedCallExpr:int dprintf
// CHECK-NEXT:           ResolvedIntLiteral:int '1'
// CHECK-NEXT:           | value:int 1
// CHECK-NEXT:           ResolvedUnaryOperator:&char[14] '&'
// CHECK-NEXT:             ResolvedStringLiteral:char[14] 'The last one\n'